<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Processing...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
  <style>
    body { font-family: sans-serif; text-align: center; padding-top: 50px; color: #333; }
    #msg { font-size: 18px; font-weight: bold; }
    .error { color: red; font-size: 14px; margin-top: 20px; }
  </style>
</head>
<body>
  <div id="msg">読み込み中...<br>そのままお待ちください</div>
  <div id="error-log" class="error"></div>

  <script>
    // ▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼▼
    // 【重要】ここにGASの「ウェブアプリURL」を貼り付けてください
    const GAS_URL = "https://script.google.com/macros/s/AKfycbzS-HvmIaMkzNl65ZbWsm56md-ImZSF0Iu96fsKgB1W-laLoBPbuqk3HyPGgqYB3gej/exec";
    
    // あなたのLIFF ID (設定済み)
    const LIFF_ID = "2008690527-hcW4PPyp";
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    async function main() {
      const msgDiv = document.getElementById('msg');
      const errDiv = document.getElementById('error-log');

      try {
        // 1. LIFFの初期化
        await liff.init({ liffId: LIFF_ID });

        // ログインしていない場合はログイン画面へ
        if (!liff.isLoggedIn()) {
          liff.login();
          return;
        }

        // 2. モード確認 (URLの ?mode=borrow 等を取得)
        const params = new URLSearchParams(window.location.search);
        const mode = params.get('mode');

        if (!mode) {
          msgDiv.innerText = "エラー：NFCタグから起動してください";
          return;
        }

        msgDiv.innerText = "送信中...";
        const profile = await liff.getProfile();
        const actionText = (mode === 'borrow') ? '借りました' : '返しました';
        const logAction  = (mode === 'borrow') ? '借りる' : '返す';

        // 3. LINEトークルームに発言 (無料)
        // ※ここで失敗する場合、LINE Developersで「chat_message.write」権限がない可能性大
        await liff.sendMessages([{
          type: 'text',
          text: `${profile.displayName}が鍵を${actionText}`
        }]);

        // 4. GAS(スプレッドシート)にログ送信
        // 'no-cors' はGASへの送信で必須の設定です
        fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            userName: profile.displayName,
            userId: profile.userId,
            action: logAction
          })
        });

        // 5. 完了＆閉じる
        msgDiv.innerText = "完了！";
        setTimeout(() => {
          liff.closeWindow();
        }, 500);

      } catch (err) {
        msgDiv.innerText = "エラーが発生しました";
        errDiv.innerText = err; // エラー内容を表示
      }
    }

    main();
  </script>
</body>
</html>
