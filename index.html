<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8">
  <title>処理中...</title>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body style="text-align:center; padding-top:50px; font-family:sans-serif;">
  <div id="msg">読み込み中...</div>

  <script>
    // ▼▼▼ 書き換えエリア ▼▼▼
    const GAS_URL = "【https://script.google.com/macros/s/AKfycbx2pGoMfXddW-lW55uLZLcQMHPiUmip0MLMW8pPV-whojd2_oiH-GQjV1gmMDRANr7N/exec
】";  // 手順1のURL
    const LIFF_ID = "【https://liff.line.me/2008690527-hcW4PPyp
】";   // 手順2のID
    // ▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲▲

    async function main() {
      const msg = document.getElementById('msg');
      await liff.init({ liffId: LIFF_ID });

      if (!liff.isLoggedIn()) { liff.login(); return; }

      // URLからモード(?mode=borrow等)を取得
      const mode = new URLSearchParams(window.location.search).get('mode');
      if (!mode) { msg.innerText = "NFCタグから起動してください"; return; }

      try {
        msg.innerText = "送信中...";
        const profile = await liff.getProfile();
        const actionText = (mode === 'borrow') ? '借りました' : '返しました';

        // 1. LINEトークに自動発言
        await liff.sendMessages([{ type: 'text', text: `${profile.displayName}が鍵を${actionText}` }]);

        // 2. GASにログ送信
        fetch(GAS_URL, {
          method: 'POST',
          mode: 'no-cors', 
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ 
            userName: profile.displayName, 
            userId: profile.userId, 
            action: mode === 'borrow' ? '借りる' : '返す' 
          })
        });

        msg.innerText = "完了！";
        setTimeout(() => liff.closeWindow(), 500);

      } catch (err) {
        msg.innerText = "エラー: " + err;
      }
    }
    main();
  </script>
</body>
</html>
